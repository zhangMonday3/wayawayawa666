name: ä¿æŒè„šæœ¬æ´»è·ƒ

# è¿™ä¸ªè„šæœ¬ç”¨äºä¿æŒä»“åº“æ´»è·ƒï¼Œé˜²æ­¢actionså› ä¸ºä»“åº“ä¸æ´»è·ƒè‡ªåŠ¨ç¦ç”¨ã€‚ä½ å¯ä»¥ä¸ç”¨ç®¡å®ƒ

on:
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 0 ç‚¹è§¦å‘ï¼ˆUTC+8ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹

jobs:
  sync-upstream:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²ï¼Œä¾¿äº rebase

      - name: è®¾ç½® Git é…ç½®
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“
        run: |
          if ! git remote | grep -q upstream; then
            git remote add upstream https://github.com/zhangMonday3/wayawayawa666.git
          fi

      - name: è·å–æ›´æ–°ä»£ç 
        run: git fetch upstream

      - name: åˆ‡æ¢åˆ° main åˆ†æ”¯
        run: git checkout main

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        id: check-update
        run: |
          UPSTREAM_UPDATES=$(git rev-list --count main..upstream/main)
          if [ "$UPSTREAM_UPDATES" -gt 0 ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°æ˜¯å¦åŒ…å« workflow æ–‡ä»¶
        if: steps.check-update.outputs.has_update == 'true'
        id: check-workflow-update
        run: |
          git fetch upstream
          CHANGES=$(git diff --name-only main upstream/main)
          if echo "$CHANGES" | grep -q '\.github/workflows/'; then
            echo "has_workflow_update=true" >> $GITHUB_OUTPUT
          else
            echo "has_workflow_update=false" >> $GITHUB_OUTPUT
          fi

      - name: æ‹‰å–ä¸Šæ¸¸ä»£ç å¹¶åŒæ­¥ï¼ˆå¦‚æœæœ‰æ›´æ–°ï¼‰
        if: steps.check-update.outputs.has_update == 'true' && steps.check-workflow-update.outputs.has_workflow_update == 'false'
        run: |
          set -e
          git fetch upstream
          if git rebase upstream/main; then
            git push origin main --force-with-lease
            echo "âœ… å·²æˆåŠŸæ›´æ–°æœ€æ–°ä»£ç "
          else
            git rebase --abort
            echo "âš ï¸ æ›´æ–°å¼‚å¸¸ï¼Œæ‰§è¡Œç©ºæäº¤ä¿æŒæ´»è·ƒ"
            git commit --allow-empty -m "ä¿æŒä»“åº“æ´»è·ƒï¼ˆæ›´æ–°å¤±è´¥å›é€€ï¼‰"
            git push origin main
          fi

      - name: æç¤ºæ‰‹åŠ¨æ›´æ–°ï¼ˆå¦‚æœä¸Šæ¸¸æ›´æ–°åŒ…å« workflow æ–‡ä»¶ï¼‰
        if: steps.check-update.outputs.has_update == 'true' && steps.check-workflow-update.outputs.has_workflow_update == 'true'
        run: |
          echo "âš ï¸ ä¸Šæ¸¸æ›´æ–°åŒ…å« workflow è„šæœ¬å†…å®¹ï¼Œæ— æ³•è‡ªåŠ¨æ›´æ–°ã€‚è¯·åœ¨ä½  fork çš„ä»“åº“ä¸­æ‰¾åˆ° 'Sync fork'æŒ‰é’®ï¼Œæ‰‹åŠ¨ç‚¹å‡»æ›´æ–°ã€‚"
          # åŒæ—¶æ‰§è¡Œç©ºæäº¤ä¿æŒæ´»è·ƒ
          git pull origin main --rebase
          git commit --allow-empty -m "ç©ºä¿®æ”¹ï¼Œæ£€æµ‹åˆ°æœ‰æ›´æ–°ï¼Œè¯·æ‰‹åŠ¨æ›´æ–°ä¸€ä¸‹"
          git push origin main
          echo "ğŸŸ¢ å·²æäº¤ç©ºä¿®æ”¹ä¿æŒä»“åº“æ´»è·ƒ"

      - name: æäº¤ç©ºä¿®æ”¹ï¼ˆå¦‚æœæ— æ›´æ–°ï¼‰
        if: steps.check-update.outputs.has_update == 'false'
        run: |
          git pull origin main --rebase
          git commit --allow-empty -m "ä¿æŒä»“åº“æ´»è·ƒï¼šç©ºä¿®æ”¹"
          git push origin main
          echo "ğŸŸ¢ æ— æ›´æ–°ï¼Œå·²æäº¤ç©ºä¿®æ”¹ä¿æŒä»“åº“æ´»è·ƒ"
